@page "/AudioEncodingPage"
@using SteganoBlaze.Components.Audio;
@inject AppState AppState
@inject IStringLocalizer<Resource> Localize
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>@Localize["AudioEncoding"]</PageTitle>

<a hidden id="saveLink" download="" href="" target="_blank"/>
<MudGrid Spacing="1">
	<MudItem sm="12" md="6" xs="12">
        <MudPaper Elevation="3" Class="py-0 my-0" Style="height:100%">
			<OpenAudio Disabled=@processing OnAudioChanged=@((WAV c) => CarrierChanged(c))/>
        </MudPaper>
	</MudItem>

	<MudItem sm="12" md="6" xs="12"> 
		<MudPaper Elevation="3" Style="height:100%">
			<OpenMessage Disabled=@processing OnMessageChanged=@((Message m) => MessageChanged(m))/>
		</MudPaper>
	</MudItem>

	<MudItem xs="12" sm="6">
        <MudPaper Elevation="3" Style="height:100%">
			<SampleBitsPicker BitsPerSample=@carrier?.BitsPerSample OnSampleBitsToEncodeChanged=@((int s) => SampleBitsToEncodeChanged(s))/>
        </MudPaper>
	</MudItem>

	<MudItem xs="12" sm="6">
        <MudPaper Elevation="3" Style="height:100%" Class="d-flex flex-column">
			<EncodingInformation 
				Capacity=@((carrier?.GetTotalSampleCount() ?? 0) * options.BitsToEncode / 8.0)
				MessageSize=@(message?.GetMessageSize() ?? 0)
				OnMessageFitsChanged=@((bool e) => MessageFitsChanged(e))>
			</EncodingInformation>
        </MudPaper>
	</MudItem>

		<MudItem xs="12">
        <MudPaper Elevation="3" Style="height:100%" Class="d-flex align-center justify-center mud-width-full">
			<EncodingOptions 
					Disabled=@processing
					OnOptionsChanged=@((SteganographyOptions o) => OptionsChanged(o))>
			</EncodingOptions>
        </MudPaper>
	</MudItem>

	<MudItem xs="12">
        <MudPaper Elevation="3" Class="d-flex align-center justify-center mud-width-full pa-0">
			<AudioEncode
				CanEncode=@(messageFits && validPassword)
				Carrier=@carrier
				Message=@message
				Options=@options
				OnProcessingChanged=@((bool p) => ProcessingChanged(p))
				OnEncodedCarrierChanged=@((File c) => EncodedCarrierChanged(c))>
			</AudioEncode>
        </MudPaper>
	</MudItem>

	<MudItem xs="12" hidden="@(carrier is null)">
		<MudPaper Elevation="3" Style="height:100%" Class="px-0 mx-0">
			<AudioPreview Label=@Localize["OriginalAudio"] Carrier=@carrier/>
        </MudPaper>
	</MudItem>

	<MudItem xs="12" hidden=" @(encodedCarrier is null)">
		<MudPaper Elevation="3" Style="height:100%" Class="px-0 mx-0">
			<AudioPreview Label=@Localize["EncodedAudio"] Carrier=@encodedCarrier/>
        </MudPaper>
	</MudItem>

</MudGrid>

@code 
{
	WAV? carrier;
	Message? message;
	File? encodedCarrier;

	byte[]? messageDecompressed;

	bool messageFits = false;
	bool validPassword = true;
	bool processing = false;

	AudioSteganographyOptions options = new AudioSteganographyOptions();

	protected override void OnInitialized()
	{
		AppState.OnChange += StateHasChanged;
		AppState.SetPageTheme(Color.Tertiary, "AudioEncoding");
	}

	async Task CarrierChanged(WAV value)
	{
		carrier = null;
		StateHasChanged();
		await Task.Delay(100);
		encodedCarrier = null;
		carrier = value;
	}
	void MessageFitsChanged(bool value) { messageFits = value; }
	void ProcessingChanged(bool value) 
	{ 
		processing = value;
		if(processing is true)
			encodedCarrier = null;
	}
	void EncodedCarrierChanged(File value) { encodedCarrier = value; }

	async Task MessageChanged(Message newMessage)
	{
		messageDecompressed = null;
		message = newMessage;
		if(options.CompressionEnabled is true)
			await ChangeCompression(true);
	}
	async Task OptionsChanged(SteganographyOptions value)
	{
		if (options.CompressionEnabled != value.CompressionEnabled)
			await ChangeCompression(value.CompressionEnabled);

		options.CompressionEnabled = value.CompressionEnabled;
		options.EncryptionEnabled = value.EncryptionEnabled;
		options.ScatteredEncodingEnabled = value.ScatteredEncodingEnabled;
		options.Password = value.Password;

		if (options.EncryptionEnabled is false || (options.EncryptionEnabled is true && options.Password is not null))
			validPassword = true;
		else
			validPassword = false;
	}

	async Task ChangeCompression(bool compressionEnabled)
	{
		if (message is null) return;

		if (compressionEnabled is true)
		{
			try
			{
				messageDecompressed = message.ByteData;
				message.ByteData = await Compression.Compress(message.ByteData);
				message.IsCompressed = true;
			}
			catch
			{
				Snackbar.Add(Localize["ErrorCompressingMessage"], Severity.Error);
			}
		}
		else
		{
			message.ByteData = messageDecompressed!;
			messageDecompressed = null;
			message.IsCompressed = false;
		}
		message.UpdateHeader();
	}
	void SampleBitsToEncodeChanged(int value)
	{
		options.BitsToEncode = value;
	}
	public void Dispose()
	{
		AppState.OnChange -= StateHasChanged;
	}
}